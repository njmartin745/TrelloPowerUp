<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="https://p.trellocdn.com/power-up.min.css">
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { 
      width: 100%; 
      /*min-width: 580px; /* Slightly less than 600px to account for potential scrollbar */
      height: 100%; 
      padding: 20px; 
      margin: 0; 
      overflow: auto;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Noto Sans', 'Ubuntu', 'Droid Sans', 'Helvetica Neue', sans-serif;
    }
    #report-container {
      max-width: 800px;
      margin: 0 auto;
    }
    h2 {
      margin-top: 0;
      font-size: 20px;
      margin-bottom: 15px;
    }
    canvas {
      max-width: 100%;
      height: 300px !important;
      margin-bottom: 15px;
    }
    #filter-container, #summary-container {
      margin-bottom: 15px;
    }
    #capacity-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    #capacity-table th, #capacity-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    #capacity-table th {
      background-color: #f2f2f2;
    }
    #chart-legend {
      display: flex;
      justify-content: center;
      margin-top: 10px;
    }
    #chart-container {
      position: relative;
      height: 400px;
    }
    #capacityChart {
      width: 100% !important;
      height: 400px !important;
    } 
    .list-selector {
      width: 300px;
      font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Noto Sans, Ubuntu, Droid Sans, Helvetica Neue, sans-serif;
      margin-bottom: 10px;
    }

    .list-selector-label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .list-icon {
      margin-right: 4px;
    }

    .list-selector-container {
      position: relative;
      display: flex;
      align-items: center;
    }

    .list-selector-input {
      width: 100%;
      padding: 8px 30px 8px 12px;
      font-size: 14px;
      border: 1px solid #dfe1e6;
      border-radius: 3px;
      background-color: #fafbfc;
    }

    .list-dropdown-toggle {
      position: absolute;
      right: 8px;
      background: none;
      border: none;
      font-size: 14px;
      color: #5e6c84;
      cursor: pointer;
    }

    .list-dropdown {
      position: absolute;
      width: 100%;
      max-height: 300px;
      overflow-y: auto;
      background-color: white;
      border: 1px solid #dfe1e6;
      border-radius: 3px;
      box-shadow: 0 8px 16px -4px rgba(9, 30, 66, 0.25), 0 0 0 1px rgba(9, 30, 66, 0.08);
      z-index: 1;
    }

    .list-option {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      cursor: pointer;
    }

    .list-option:hover {
      background-color: #f4f5f7;
    }

    .list-option input[type="checkbox"] {
      margin-right: 8px;
    }

    .list-option-name {
      flex-grow: 1;
      font-size: 14px;
    }

    .list-option-count {
      color: #5e6c84;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div id="report-container">
    <h2>Team Capacity Report</h2>
    <div id="filter-container">
      <label for="time-period">Time Period:</label>
      <select id="time-period">
        <option value="this-week">This Week</option>
        <option value="next-week">Next Week</option>
        <option value="this-month">This Month</option>
      </select>
    </div>
    <div class="list-selector">
      <label class="list-selector-label">
        <span class="list-icon">ðŸ“‹</span> List
      </label>
      <div class="list-selector-container">
        <input type="text" id="list-search" class="list-selector-input" placeholder="Search lists...">
        <button id="list-dropdown-toggle" class="list-dropdown-toggle">â–¼</button>
      </div>
      <div id="list-dropdown" class="list-dropdown" style="display: none;">
        <!-- List options will be populated here -->
      </div>
    </div>
  
  
  
  
  
  
  
  
  
  
    <canvas id="capacityChart"></canvas>
    <div id="summary-container"></div>
    <table id="capacity-table">
      <thead>
        <tr>
          <th>Member</th>
          <th>Assigned Work</th>
          <th>Capacity</th>
          <th>Utilization</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div id="debug-info"></div>
  <script>
    var t = TrelloPowerUp.iframe();
    var chart;
    var debugInfo = "";
    const CAPACITY_THRESHOLD = 0.8; // 80% threshold

    function log(message) {
      debugInfo += message + "\n";
      document.getElementById('debug-info').textContent = debugInfo;
    }

  function populateListSelect(lists) {
  var listOptions = document.querySelector('.list-options');
  listOptions.innerHTML = '';
  lists.forEach(function(list) {
    var option = document.createElement('div');
    option.className = 'list-option';
    option.innerHTML = `
      <input type="checkbox" id="list-${list.id}" value="${list.id}">
      <span class="list-option-name">${list.name}</span>
      <span class="list-option-count">${list.cardCount || 0}</span>
    `;
    listOptions.appendChild(option);
  });
}

function setupListSelector() {
  var dropdownToggle = document.getElementById('list-dropdown-toggle');
  var dropdown = document.getElementById('list-dropdown');
  var searchInput = document.getElementById('list-search');
  var listSelectorContainer = document.querySelector('.list-selector-container');

  dropdownToggle.addEventListener('click', function(event) {
    event.stopPropagation();
    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
  });

  searchInput.addEventListener('input', function() {
    var filter = this.value.toLowerCase();
    var options = document.querySelectorAll('.list-option');
    options.forEach(function(option) {
      var text = option.textContent.toLowerCase();
      option.style.display = text.includes(filter) ? '' : 'none';
    });
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', function(event) {
    if (!listSelectorContainer.contains(event.target)) {
      dropdown.style.display = 'none';
    }
  });

  // Prevent dropdown from closing when clicking inside
  dropdown.addEventListener('click', function(event) {
    event.stopPropagation();
  });
}

t.render(function() {
  return t.lists('id', 'name')
    .then(function(lists) {
      // Get card counts for each list
      return Promise.all(lists.map(list => 
        t.list(list.id, 'name', 'cards')
          .then(listData => ({
            ...list,
            cardCount: listData.cards.length
          }))
      ));
    })
    .then(function(listsWithCounts) {
      populateListSelect(listsWithCounts);
      setupListSelector();
      updateReport();
    });
});

    function updateReport() {
  console.log("Starting updateReport function");
  var timePeriod = document.getElementById('time-period').value;
  var currentDate = new Date();
  var startDate, endDate;

  switch(timePeriod) {
    case 'this-week':
      startDate = getStartOfWeek(currentDate);
      endDate = new Date(startDate);
      endDate.setDate(endDate.getDate() + 6);
      break;
    case 'next-week':
      startDate = getStartOfWeek(new Date(currentDate.setDate(currentDate.getDate() + 7)));
      endDate = new Date(startDate);
      endDate.setDate(endDate.getDate() + 6);
      break;
    case 'this-month':
      startDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
      endDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
      break;
  }

  console.log(`Time period: ${timePeriod}, Start: ${startDate.toISOString()}, End: ${endDate.toISOString()}`);

  // Get selected lists
  var selectedLists = getSelectedLists();

  Promise.all([
    t.board('id', 'name', 'members', 'labels'),
    t.lists('id', 'name'),
    t.cards('all')
  ])
  .then(function([board, lists, cards]) {
    console.log(`Board: ${board.name}, Members: ${board.members.length}, Labels: ${board.labels.length}, Lists: ${lists.length}`);
    console.log(`Retrieved ${cards.length} cards`);

    var labelColors = {};
    board.labels.forEach(label => {
      labelColors[label.name] = label.color;
    });

    var memberWorkloads = {};
    board.members.forEach(function(member) {
      memberWorkloads[member.id] = {
        id: member.id,
        name: member.fullName,
        workload: 0,
        labels: {}
      };
    });

    function processNextCard(index) {
      if (index >= cards.length) {
        console.log(`Processed all cards. Updating chart with ${Object.keys(memberWorkloads).length} members.`);
        updateChart(memberWorkloads, labelColors);
        updateTable(memberWorkloads);
        updateSummary(memberWorkloads);
        return;
      }

      var card = cards[index];
      console.log(`Processing card: ${card.name}, Due: ${card.due}, List: ${card.idList}`);

      if (shouldIncludeCard(card, startDate, endDate, selectedLists)) {
        t.get(card.id, 'shared', 'memberEfforts')
          .then(function(memberEfforts) {
            console.log(`Member efforts for card ${card.name}: ${JSON.stringify(memberEfforts)}`);
            if (memberEfforts) {
              Object.entries(memberEfforts).forEach(([memberId, effort]) => {
                if (memberWorkloads[memberId]) {
                  memberWorkloads[memberId].workload += parseFloat(effort);
                  card.labels.forEach(label => {
                    if (!memberWorkloads[memberId].labels[label.name]) {
                      memberWorkloads[memberId].labels[label.name] = 0;
                    }
                    memberWorkloads[memberId].labels[label.name] += parseFloat(effort) / card.labels.length;
                  });
                } else {
                  console.log(`Warning: Member ${memberId} not found in board members.`);
                }
              });
            }
            processNextCard(index + 1);
          })
          .catch(function(error) {
            console.error(`Error processing card ${card.name}: ${error}`);
            processNextCard(index + 1);
          });
      } else {
        console.log(`Card ${card.name} not included in report`);
        processNextCard(index + 1);
      }
    }

    processNextCard(0);
  })
  .catch(function(error) {
    console.error(`Error retrieving board data: ${error}`);
  });
}

function shouldIncludeCard(card, startDate, endDate, includedLists) {
  // Check if the card is in one of the included lists
  if (!includedLists.includes(card.idList)) {
    return false;
  }

  // Check if the card has a due date assigned
  if (!card.due) {
    return false;
  }

  // Check if the card is not complete
  if (card.dueComplete) {
    return false;
  }

  // Check if the due date is within the specified range
  var cardDueDate = new Date(card.due);
  return cardDueDate >= startDate && cardDueDate <= endDate;
}

function getStartOfWeek(date) {
  var diff = date.getDate() - date.getDay() + (date.getDay() === 0 ? -6 : 1);
  return new Date(date.setDate(diff));
}
function aggregateMemberHours(memberHours) {
  const labelHoursMap = {};
  memberHours.forEach(mh => {
    if (mh.labels && mh.labels.length > 0) {
      mh.labels.forEach(label => {
        if (!labelHoursMap[label.id]) {
          labelHoursMap[label.id] = { 
            name: label.name, 
            color: label.color, 
            members: {}
          };
        }
        if (!labelHoursMap[label.id].members[mh.memberId]) {
          labelHoursMap[label.id].members[mh.memberId] = {
            name: mh.memberName,
            hours: 0
          };
        }
        labelHoursMap[label.id].members[mh.memberId].hours += mh.hours;
      });
    } else {
      const noLabelId = 'no-label';
      if (!labelHoursMap[noLabelId]) {
        labelHoursMap[noLabelId] = {
          name: 'No Label',
          color: 'gray',
          members: {}
        };
      }
      if (!labelHoursMap[noLabelId].members[mh.memberId]) {
        labelHoursMap[noLabelId].members[mh.memberId] = {
          name: mh.memberName,
          hours: 0
        };
      }
      labelHoursMap[noLabelId].members[mh.memberId].hours += mh.hours;
    }
  });
  return labelHoursMap;
}

function updateChart(memberWorkloads, labelColors) {
  console.log("Starting updateChart function");
  console.log("memberWorkloads:", memberWorkloads);

  var ctx = document.getElementById('capacityChart').getContext('2d');
  
  var members = Object.keys(memberWorkloads);
  console.log("Members:", members);

  var labels = Array.from(new Set(Object.values(memberWorkloads).flatMap(m => Object.keys(m.labels))));
  console.log("Labels:", labels);

  var datasets = labels.map(label => ({
    label: label,
    data: members.map(memberId => memberWorkloads[memberId].labels[label] || 0),
    backgroundColor: getColorForTrelloLabel(labelColors[label] || 'blue'),
  }));

  console.log("Datasets:", datasets);

  if (window.capacityChart && typeof window.capacityChart.destroy === 'function') {
    window.capacityChart.destroy();
  }

  try {
    window.capacityChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: members.map(memberId => memberWorkloads[memberId].name),
        datasets: datasets
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { 
            stacked: true,
            grid: {
              display: false
            },
            ticks: {
              autoSkip: false,
              maxRotation: 90,
              minRotation: 90
            }
          },
          y: { 
            stacked: true,
            beginAtZero: true,
            max: 40,
            ticks: {
              stepSize: 10,
              callback: function(value) {
                return value + 'h';
              }
            }
          }
        },
        plugins: {
          legend: {
            display: false  // This line removes the legend
          },
          title: {
            display: true,
            text: 'Team Capacity Utilization by Member',
            font: {
              size: 16
            }
          },
          tooltip: {
            callbacks: {
              title: function(context) {
                return context[0].label;
              },
              label: function(context) {
                return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}h`;
              }
            }
          }
        }
      },
      plugins: [{ 
        id: 'thresholdLine', 
        beforeDraw: (chart) => { 
          const ctx = chart.ctx; 
          const yAxis = chart.scales.y; 
          const thresholdValue = 32; 
          const yPixel = yAxis.getPixelForValue(thresholdValue); 
          ctx.save(); 
          ctx.beginPath(); 
          ctx.moveTo(chart.chartArea.left, yPixel); 
          ctx.lineTo(chart.chartArea.right, yPixel); 
          ctx.lineWidth = 2; 
          ctx.strokeStyle = 'rgba(255, 0, 0, 0.8)'; 
          ctx.stroke(); 
          ctx.fillStyle = 'rgba(255, 0, 0, 0.8)';
          ctx.textAlign = 'left';
          /*ctx.fillText('80% Capacity (32h)', chart.chartArea.left, yPixel - 5);*/
          ctx.restore(); 
        } 
      }]
    });
    console.log("Chart rendered successfully");
  } catch (error) {
    console.error("Error rendering chart:", error);
  }
}

function getColorForTrelloLabel(colorName) {
  const colorMap = {
    'green': 'rgba(97, 189, 79, 0.8)',
    'yellow': 'rgba(242, 214, 0, 0.8)',
    'orange': 'rgba(255, 159, 26, 0.8)',
    'red': 'rgba(235, 90, 70, 0.8)',
    'purple': 'rgba(131, 140, 199, 0.8)',
    'blue': 'rgba(0, 121, 191, 0.8)',
    'sky': 'rgba(0, 194, 224, 0.8)',
    'lime': 'rgba(81, 232, 152, 0.8)',
    'pink': 'rgba(255, 120, 203, 0.8)',
    'black': 'rgba(73, 78, 92, 0.8)'
  };
  return colorMap[colorName] || 'rgba(0, 121, 191, 0.8)'; // Default to blue if color not found
}


    function updateTable(memberWorkloads) {
      var tableBody = document.querySelector('#capacity-table tbody');
      tableBody.innerHTML = '';
      Object.values(memberWorkloads).forEach(function(member) {
        var row = tableBody.insertRow();
        row.insertCell().textContent = member.name;
        row.insertCell().textContent = member.workload.toFixed(1) + ' hours';
        row.insertCell().textContent = member.capacity + ' hours';
        var utilization = (member.workload / member.capacity) * 100;
        row.insertCell().textContent = utilization.toFixed(1) + '%';
      });
    }

    function updateSummary(labelHours) {
  var totalCapacity = 0;
  var totalWorkload = 0;
  
  Object.values(labelHours).forEach(label => {
    Object.values(label.members).forEach(member => {
      totalWorkload += member.hours;
      totalCapacity += 40; // Assuming 40 hours capacity per member
    });
  });

  var totalUtilization = totalCapacity > 0 ? (totalWorkload / totalCapacity) * 100 : 0;

  var summaryContainer = document.getElementById('summary-container');
  summaryContainer.innerHTML = `
    <p><strong>Total Team Capacity:</strong> ${totalCapacity.toFixed(1)} hours</p>
    <p><strong>Total Assigned Work:</strong> ${totalWorkload.toFixed(1)} hours</p>
    <p><strong>Overall Utilization:</strong> ${totalUtilization.toFixed(1)}%</p>
  `;
}

    document.getElementById('time-period').addEventListener('change', updateReport);

    t.render(function() {
  return t.lists('id', 'name')
    .then(function(lists) {
      populateListSelect(lists);
      updateReport();
    });
});
  </script>
</body>
</html>