<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="https://p.trellocdn.com/power-up.min.css">
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { 
      width: 100%; 
      height: 100%; 
      padding: 10px; 
      margin: 0; 
      overflow: auto;
      box-sizing: border-box;
    }
    #report-container {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Noto Sans', 'Ubuntu', 'Droid Sans', 'Helvetica Neue', sans-serif;
    }
    h2 {
      margin-top: 0;
      font-size: 20px;
      margin-bottom: 15px;
    }
    canvas {
      max-width: 100%;
      height: 250px !important;
      margin-bottom: 15px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    #filter-container {
      margin-bottom: 15px;
    }
    #summary-container {
      font-size: 16px;
      margin-bottom: 15px;
    }
    #debug-info {
      margin-top: 15px;
      padding: 8px;
      background-color: #f0f0f0;
      border: 1px solid #ccc;
      font-family: monospace;
      white-space: pre-wrap;
      font-size: 12px;
      max-height: 100px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div id="report-container">
    <h2>Team Capacity Report</h2>
    <div id="filter-container">
      <label for="time-period">Time Period:</label>
      <select id="time-period">
        <option value="this-week">This Week</option>
        <option value="next-week">Next Week</option>
        <option value="this-month">This Month</option>
      </select>
    </div>
    <canvas id="capacityChart"></canvas>
    <div id="summary-container"></div>
    <table id="capacity-table">
      <thead>
        <tr>
          <th>Member</th>
          <th>Assigned Work</th>
          <th>Capacity</th>
          <th>Utilization</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div id="debug-info"></div>
  <script>
    var t = TrelloPowerUp.iframe();
    var chart;
    var debugInfo = "";
    const CAPACITY_THRESHOLD = 0.8; // 80% threshold

    function log(message) {
      debugInfo += message + "\n";
      document.getElementById('debug-info').textContent = debugInfo;
    }

    function getStartOfWeek(date) {
      var diff = date.getDate() - date.getDay() + (date.getDay() === 0 ? -6 : 1);
      return new Date(date.setDate(diff));
    }

    function getStartOfMonth(date) {
      return new Date(date.getFullYear(), date.getMonth(), 1);
    }

    function getEndOfMonth(date) {
      return new Date(date.getFullYear(), date.getMonth() + 1, 0);
    }

    function isCardInDateRange(card, startDate, endDate) {
      if (!card.due) {
        log(`Card ${card.name} has no due date`);
        return false;
      }
      var cardDueDate = new Date(card.due);
      var result = cardDueDate >= startDate && cardDueDate <= endDate;
      log(`Card ${card.name} due date: ${cardDueDate.toISOString()}, Start: ${startDate.toISOString()}, End: ${endDate.toISOString()}, In range: ${result}`);
      return result;
    }

    function updateReport() {
      debugInfo = ""; // Reset debug info
      log("Updating report...");
      var timePeriod = document.getElementById('time-period').value;
      var currentDate = new Date();
      var startDate, endDate;

      switch(timePeriod) {
        case 'this-week':
          startDate = getStartOfWeek(currentDate);
          endDate = new Date(startDate);
          endDate.setDate(endDate.getDate() + 6);
          break;
        case 'next-week':
          startDate = getStartOfWeek(new Date(currentDate.setDate(currentDate.getDate() + 7)));
          endDate = new Date(startDate);
          endDate.setDate(endDate.getDate() + 6);
          break;
        case 'this-month':
          startDate = getStartOfMonth(currentDate);
          endDate = getEndOfMonth(currentDate);
          break;
      }

      log(`Time period: ${timePeriod}, Start: ${startDate.toISOString()}, End: ${endDate.toISOString()}`);

      t.board('id', 'name', 'members')
        .then(function(board) {
          log(`Board: ${board.name}, Members: ${board.members.length}`);
          return Promise.all([
            board,
            t.cards('all')
          ]);
        })
        .then(function([board, cards]) {
          log(`Retrieved ${cards.length} cards`);
          var memberWorkloads = {};
          board.members.forEach(function(member) {
            memberWorkloads[member.id] = {
              id: member.id,
              name: member.fullName,
              workload: 0,
              capacity: 40,
              availableCapacity: 40
            };
          });

          var processedCards = 0;
          var cardsWithEffort = 0;

          function processNextCard(index) {
            if (index >= cards.length) {
              log(`Processed all cards. Cards with effort: ${cardsWithEffort}`);
              updateChart(memberWorkloads);
              updateTable(memberWorkloads);
              updateSummary(memberWorkloads);
              return;
            }

            var card = cards[index];
            log(`Processing card: ${card.name}, Due: ${card.due}`);

            if (isCardInDateRange(card, startDate, endDate)) {
              t.get(card.id, 'shared', 'memberEfforts')
                .then(function(memberEfforts) {
                  log(`Member efforts for card ${card.name}: ${JSON.stringify(memberEfforts)}`);
                  if (memberEfforts) {
                    cardsWithEffort++;
                    Object.entries(memberEfforts).forEach(([memberId, effort]) => {
                      if (memberWorkloads[memberId]) {
                        memberWorkloads[memberId].workload += parseFloat(effort);
                        memberWorkloads[memberId].availableCapacity = Math.max(0, 40 - memberWorkloads[memberId].workload);
                        log(`Added ${effort} hours to ${memberWorkloads[memberId].name}`);
                      }
                    });
                  }
                  processNextCard(index + 1);
                })
                .catch(function(error) {
                  log(`Error processing card ${card.name}: ${error}`);
                  processNextCard(index + 1);
                });
            } else {
              log(`Card ${card.name} not in date range`);
              processNextCard(index + 1);
            }
          }

          processNextCard(0);
        })
        .catch(function(error) {
          log(`Error retrieving board data: ${error}`);
        });
    }

    function updateChart(memberWorkloads) {
  log("Updating chart...");
  var ctx = document.getElementById('capacityChart').getContext('2d');
  var labels = Object.values(memberWorkloads).map(m => m.name);
  var assignedWork = Object.values(memberWorkloads).map(m => m.workload);

  if (chart) {
    chart.destroy();
  }

  chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Assigned Work',
        data: assignedWork,
        backgroundColor: assignedWork.map(work => work > 32 ? 'rgba(235, 90, 70, 0.8)' : 'rgba(97, 189, 79, 0.8)'),
        borderColor: assignedWork.map(work => work > 32 ? 'rgb(235, 90, 70)' : 'rgb(97, 189, 79)'),
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { 
          grid: {
            display: false
          }
        },
        y: { 
          beginAtZero: true,
          max: 40,
          ticks: {
            stepSize: 10,
            callback: function(value) {
              return value + 'h';
            }
          },
          grid: {
            color: 'rgba(0, 0, 0, 0.1)'
          }
        }
      },
      plugins: {
        legend: {
          display: false
        },
        annotation: {
          annotations: {
            line1: {
              type: 'line',
              yMin: 32,
              yMax: 32,
              borderColor: 'rgba(255, 99, 132, 0.8)',
              borderWidth: 2,
              borderDash: [5, 5],
              label: {
                content: '80% Capacity',
                enabled: true,
                position: 'end'
              }
            }
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return context.parsed.y + ' hours';
            }
          }
        }
      }
    }
  });
  log("Chart updated");}

    function getColorForTrelloLabel(colorName) {
      const colorMap = {
        'green': 'rgba(97, 189, 79, 0.8)',
        'yellow': 'rgba(242, 214, 0, 0.8)',
        'orange': 'rgba(255, 159, 26, 0.8)',
        'red': 'rgba(235, 90, 70, 0.8)',
        'purple': 'rgba(131, 140, 199, 0.8)',
        'blue': 'rgba(0, 121, 191, 0.8)',
        'sky': 'rgba(0, 194, 224, 0.8)',
        'lime': 'rgba(81, 232, 152, 0.8)',
        'pink': 'rgba(255, 120, 203, 0.8)',
        'black': 'rgba(73, 78, 92, 0.8)'
      };
      return colorMap[colorName] || 'rgba(0, 121, 191, 0.8)'; // Default to blue if color not found
    }

    function updateTable(memberWorkloads) {
      var tableBody = document.querySelector('#capacity-table tbody');
      tableBody.innerHTML = '';
      Object.values(memberWorkloads).forEach(function(member) {
        var row = tableBody.insertRow();
        row.insertCell().textContent = member.name;
        row.insertCell().textContent = member.workload.toFixed(1) + ' hours';
        row.insertCell().textContent = member.capacity + ' hours';
        var utilization = (member.workload / member.capacity) * 100;
        row.insertCell().textContent = utilization.toFixed(1) + '%';
      });
    }

    function updateSummary(memberWorkloads) {
      var totalCapacity = Object.values(memberWorkloads).reduce((sum, member) => sum + member.capacity, 0);
      var totalWorkload = Object.values(memberWorkloads).reduce((sum, member) => sum + member.workload, 0);
      var totalUtilization = (totalWorkload / totalCapacity) * 100;

      var summaryContainer = document.getElementById('summary-container');
      summaryContainer.innerHTML = `
        <p><strong>Total Team Capacity:</strong> ${totalCapacity} hours</p>
        <p><strong>Total Assigned Work:</strong> ${totalWorkload.toFixed(1)} hours</p>
        <p><strong>Overall Utilization:</strong> ${totalUtilization.toFixed(1)}%</p>
      `;
    }

    document.getElementById('time-period').addEventListener('change', updateReport);

    t.render(function() {
      log("Render function called");
      updateReport();
    });
  </script>
</body>
</html>