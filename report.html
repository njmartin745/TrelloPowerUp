<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="https://p.trellocdn.com/power-up.min.css">
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { 
      width: 100%; 
      /*min-width: 580px; /* Slightly less than 600px to account for potential scrollbar */
      height: 100%; 
      padding: 20px; 
      margin: 0; 
      overflow: auto;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Noto Sans', 'Ubuntu', 'Droid Sans', 'Helvetica Neue', sans-serif;
    }
    #report-container {
      max-width: 800px;
      margin: 0 auto;
    }
    h2 {
      margin-top: 0;
      font-size: 20px;
      margin-bottom: 15px;
    }
    canvas {
      max-width: 100%;
      height: 300px !important;
      margin-bottom: 15px;
    }
    #filter-container, #summary-container {
      margin-bottom: 15px;
    }
    #capacity-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    #capacity-table th, #capacity-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    #capacity-table th {
      background-color: #f2f2f2;
    }
    #chart-legend {
      display: flex;
      justify-content: center;
      margin-top: 10px;
    }
    #chart-container {
      position: relative;
      height: 400px;
    }
    #capacityChart {
      width: 100% !important;
      height: 400px !important;
    } 
  </style>
</head>
<body>
  <div id="report-container">
    <h2>Team Capacity Report</h2>
    <div id="filter-container">
      <label for="time-period">Time Period:</label>
      <select id="time-period">
        <option value="this-week">This Week</option>
        <option value="next-week">Next Week</option>
        <option value="this-month">This Month</option>
      </select>
    </div>
  <div id="chart-container">
    <canvas id="capacityChart"></canvas>
  </div>
  
  
  
  
  
  
  
  
  
  
    <canvas id="capacityChart"></canvas>
    <div id="summary-container"></div>
    <table id="capacity-table">
      <thead>
        <tr>
          <th>Member</th>
          <th>Assigned Work</th>
          <th>Capacity</th>
          <th>Utilization</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div id="debug-info"></div>
  <script>
    var t = TrelloPowerUp.iframe();
    var chart;
    var debugInfo = "";
    const CAPACITY_THRESHOLD = 0.8; // 80% threshold

    function log(message) {
      debugInfo += message + "\n";
      document.getElementById('debug-info').textContent = debugInfo;
    }

    function getStartOfWeek(date) {
      var diff = date.getDate() - date.getDay() + (date.getDay() === 0 ? -6 : 1);
      return new Date(date.setDate(diff));
    }

    function getStartOfMonth(date) {
      return new Date(date.getFullYear(), date.getMonth(), 1);
    }

    function getEndOfMonth(date) {
      return new Date(date.getFullYear(), date.getMonth() + 1, 0);
    }

    function isCardInDateRange(card, startDate, endDate) {
      if (!card.due) {
        log(`Card ${card.name} has no due date`);
        return false;
      }
      var cardDueDate = new Date(card.due);
      var result = cardDueDate >= startDate && cardDueDate <= endDate;
      log(`Card ${card.name} due date: ${cardDueDate.toISOString()}, Start: ${startDate.toISOString()}, End: ${endDate.toISOString()}, In range: ${result}`);
      return result;
    }

    function updateReport() {
  debugInfo = ""; // Reset debug info
  log("Updating report...");
  var timePeriod = document.getElementById('time-period').value;
  var currentDate = new Date();
  var startDate, endDate;


  switch(timePeriod) {
    case 'this-week':
      startDate = getStartOfWeek(currentDate);
      endDate = new Date(startDate);
      endDate.setDate(endDate.getDate() + 6);
      break;
    case 'next-week':
      startDate = getStartOfWeek(new Date(currentDate.setDate(currentDate.getDate() + 7)));
      endDate = new Date(startDate);
      endDate.setDate(endDate.getDate() + 6);
      break;
    case 'this-month':
      startDate = getStartOfMonth(currentDate);
      endDate = getEndOfMonth(currentDate);
      break;
  }

  log(`Time period: ${timePeriod}, Start: ${startDate.toISOString()}, End: ${endDate.toISOString()}`);

  t.board('id', 'name', 'members')
    .then(function(board) {
      log(`Board: ${board.name}, Members: ${board.members.length}`);
      return Promise.all([
        board,
        t.cards('all')
      ]);
    })
    .then(function([board, cards]) {
      log(`Retrieved ${cards.length} cards`);
      var memberWorkloads = {};
      
      // Initialize all board members with zero workload
      board.members.forEach(function(member) {
        memberWorkloads[member.id] = {
          id: member.id,
          name: member.fullName,
          workload: 0,
          labels: {}
        };
      });

      function processNextCard(index) {
        if (index >= cards.length) {
          log(`Processed all cards. Updating chart with ${Object.keys(memberWorkloads).length} members.`);
          updateChart(memberWorkloads);
          updateTable(memberWorkloads);
          updateSummary(memberWorkloads);
          return;
        }

        var card = cards[index];
        log(`Processing card: ${card.name}, Due: ${card.due}`);

        if (isCardInDateRange(card, startDate, endDate)) {
          t.get(card.id, 'shared', 'memberEfforts')
            .then(function(memberEfforts) {
              log(`Member efforts for card ${card.name}: ${JSON.stringify(memberEfforts)}`);
              if (memberEfforts) {
                Object.entries(memberEfforts).forEach(([memberId, effort]) => {
                  if (memberWorkloads[memberId]) {
                    memberWorkloads[memberId].workload += parseFloat(effort);
                    card.labels.forEach(label => {
                      if (!memberWorkloads[memberId].labels[label.name]) {
                        memberWorkloads[memberId].labels[label.name] = 0;
                      }
                      memberWorkloads[memberId].labels[label.name] += parseFloat(effort);
                    });
                  } else {
                    log(`Warning: Member ${memberId} not found in board members.`);
                  }
                });
              }
              processNextCard(index + 1);
            })
            .catch(function(error) {
              log(`Error processing card ${card.name}: ${error}`);
              processNextCard(index + 1);
            });
        } else {
          log(`Card ${card.name} not in date range`);
          processNextCard(index + 1);
        }
      }

      processNextCard(0);
    })
    .catch(function(error) {
      log(`Error retrieving board data: ${error}`);
    });
}
function aggregateMemberHours(memberHours) {
  const labelHoursMap = {};
  memberHours.forEach(mh => {
    if (mh.labels && mh.labels.length > 0) {
      mh.labels.forEach(label => {
        if (!labelHoursMap[label.id]) {
          labelHoursMap[label.id] = { 
            name: label.name, 
            color: label.color, 
            members: {}
          };
        }
        if (!labelHoursMap[label.id].members[mh.memberId]) {
          labelHoursMap[label.id].members[mh.memberId] = {
            name: mh.memberName,
            hours: 0
          };
        }
        labelHoursMap[label.id].members[mh.memberId].hours += mh.hours;
      });
    } else {
      const noLabelId = 'no-label';
      if (!labelHoursMap[noLabelId]) {
        labelHoursMap[noLabelId] = {
          name: 'No Label',
          color: 'gray',
          members: {}
        };
      }
      if (!labelHoursMap[noLabelId].members[mh.memberId]) {
        labelHoursMap[noLabelId].members[mh.memberId] = {
          name: mh.memberName,
          hours: 0
        };
      }
      labelHoursMap[noLabelId].members[mh.memberId].hours += mh.hours;
    }
  });
  return labelHoursMap;
}
/*working*/
function updateChart(labelHours) {
  log("Updating chart...");
  var ctx = document.getElementById('capacityChart').getContext('2d');
  
  // Get all unique members across all labels
  var allMembers = new Set();
  Object.values(labelHours).forEach(label => {
    Object.keys(label.members).forEach(memberId => allMembers.add(memberId));
  });

  // Reorganize data by member, including all members
  var memberData = {};
  allMembers.forEach(memberId => {
    memberData[memberId] = {
      name: '', // We'll set this later
      labels: {}
    };
  });

  Object.values(labelHours).forEach(label => {
    Object.entries(label.members).forEach(([memberId, member]) => {
      memberData[memberId].name = member.name;
      memberData[memberId].labels[label.name] = member.hours;
    });
  });

  var members = Object.keys(memberData);
  var labels = Array.from(new Set(Object.values(labelHours).map(l => l.name)));

  var datasets = labels.map(label => ({
    label: label,
    data: members.map(memberId => memberData[memberId].labels[label] || 0),
    backgroundColor: getColorForTrelloLabel(labelHours[Object.keys(labelHours).find(key => labelHours[key].name === label)].color),
  }));

  if (chart) {
    chart.destroy();
  }

  chart = new Chart(ctx, {
  type: 'bar',
  data: {
    labels: members.map(memberId => memberData[memberId].name || 'Unknown Member'),
    datasets: datasets
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    scales: {
      x: { 
        stacked: true,
        grid: {
          display: false
        },
        ticks: {
          autoSkip: false,
          maxRotation: 90,
          minRotation: 90,
          align: 'start',
          font: {
            size: 10
          },
          padding: 10
        }
      },
      y: { 
        stacked: true,
        beginAtZero: true,
        max: 40,
        ticks: {
          stepSize: 10,
          callback: function(value) {
            return value + 'h';
          }
        }
      }
    },
    plugins: {
      legend: {
        display: true,
        position: 'top'
      },
      title: {
        display: true,
        text: 'Team Capacity Utilization by Member',
        font: {
          size: 16
        }
      }
    },
    layout: {
      padding: {
        left: 0,
        right: 20,
        top: 0,
        bottom: 40
      }
    }
  },
    plugins: [{ 
      id: 'thresholdLine', 
      beforeDraw: (chart) => { 
        const ctx = chart.ctx; 
        const yAxis = chart.scales.y; 
        const thresholdValue = 32; 
        const yPixel = yAxis.getPixelForValue(thresholdValue); 
        ctx.save(); 
        ctx.beginPath(); 
        ctx.moveTo(chart.chartArea.left, yPixel); 
        ctx.lineTo(chart.chartArea.right, yPixel); 
        ctx.lineWidth = 2; 
        ctx.strokeStyle = 'rgba(255, 0, 0, 0.8)'; 
        ctx.stroke(); 
        ctx.fillStyle = 'rgba(255, 0, 0, 0.8)';
        ctx.textAlign = 'left';
        /*ctx.fillText('80% Capacity (32h)', chart.chartArea.left, yPixel - 5);*/
        ctx.restore(); 
      } 
    }]
  });
  
  log("Chart updated");
}

function getColorForTrelloLabel(colorName) {
  const colorMap = {
    'green': 'rgba(97, 189, 79, 0.8)',
    'yellow': 'rgba(242, 214, 0, 0.8)',
    'orange': 'rgba(255, 159, 26, 0.8)',
    'red': 'rgba(235, 90, 70, 0.8)',
    'purple': 'rgba(131, 140, 199, 0.8)',
    'blue': 'rgba(0, 121, 191, 0.8)',
    'sky': 'rgba(0, 194, 224, 0.8)',
    'lime': 'rgba(81, 232, 152, 0.8)',
    'pink': 'rgba(255, 120, 203, 0.8)',
    'black': 'rgba(73, 78, 92, 0.8)'
  };
  return colorMap[colorName] || 'rgba(0, 121, 191, 0.8)'; // Default to blue if color not found
}


    function updateTable(memberWorkloads) {
      var tableBody = document.querySelector('#capacity-table tbody');
      tableBody.innerHTML = '';
      Object.values(memberWorkloads).forEach(function(member) {
        var row = tableBody.insertRow();
        row.insertCell().textContent = member.name;
        row.insertCell().textContent = member.workload.toFixed(1) + ' hours';
        row.insertCell().textContent = member.capacity + ' hours';
        var utilization = (member.workload / member.capacity) * 100;
        row.insertCell().textContent = utilization.toFixed(1) + '%';
      });
    }

    function updateSummary(labelHours) {
  var totalCapacity = 0;
  var totalWorkload = 0;
  
  Object.values(labelHours).forEach(label => {
    Object.values(label.members).forEach(member => {
      totalWorkload += member.hours;
      totalCapacity += 40; // Assuming 40 hours capacity per member
    });
  });

  var totalUtilization = totalCapacity > 0 ? (totalWorkload / totalCapacity) * 100 : 0;

  var summaryContainer = document.getElementById('summary-container');
  summaryContainer.innerHTML = `
    <p><strong>Total Team Capacity:</strong> ${totalCapacity.toFixed(1)} hours</p>
    <p><strong>Total Assigned Work:</strong> ${totalWorkload.toFixed(1)} hours</p>
    <p><strong>Overall Utilization:</strong> ${totalUtilization.toFixed(1)}%</p>
  `;
}

    document.getElementById('time-period').addEventListener('change', updateReport);

    t.render(function() {
  // No need to call t.sizeTo() here anymore
  updateReport();
});
  </script>
</body>
</html>